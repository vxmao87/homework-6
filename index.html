<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Weather Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link
    rel="stylesheet"
    href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
    integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf"
    crossorigin="anonymous"
  />
    <link rel="stylesheet" href="./style.css">
</head>
<body>
  <nav class="navbar navbar-dark bg-dark justify-content-center">
    <span class="navbar-brand mb-0 h1">Weather Dashboard</span>
  </nav>
  <div class = "container">
    <div class = "row">
      <div class = "col-lg-4">
        <h1 class = "header">Search for a city:</h1>
        <form class="form-inline">
          <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search" id = searchTerm>
          <button type="button" class="btn btn-primary">
            <i class="fas fa-search"></i>
          </button>
        </form>
        <div class="btn-group-vertical d-flex justify-content-center">
          <!-- <button type="button" class="btn btn-light btn-lg btn-block" city = "Seattle">Seattle</button>
          <button type="button" class="btn btn-light btn-lg btn-block" city = "Los Angeles">Los Angeles</button> -->
        </div>
      </div>
      <div class = "col-lg-8" style = "display: none;">
        <div class="card">
          <div class="card-body">
          </div>
        </div>
        <div class = "row">
          <div class="card" style="width: 9rem;">
            <div class ="card-body0">
            </div>
          </div>
          <div class="card" style="width: 9rem;">
            <div class="card-body1">
            </div>
          </div>
          <div class="card" style="width: 9rem;">
            <div class="card-body2">
            </div>
          </div>
          <div class="card" style="width: 9rem;">
            <div class="card-body3">
            </div>
          </div>
          <div class="card" style="width: 9rem;">
            <div class="card-body4">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script type = "text/javascript">
    
    var searchHistory = [];

    function grabDate(response, index) {
      var milliseconds = response.list[index].dt * 1000;
      var dateObj = new Date(milliseconds);
      return dateObj.toLocaleDateString();
    }

    function renderPage() {
      $(".card-body").empty();
      for(var i = 0; i < 5; i++) {
        $(".card-body" + i).empty();
      }
      $(".btn-group-vertical").empty();
      searchHistory = JSON.parse(localStorage.getItem("searchHistory"));
      console.log(searchHistory);
      if(searchHistory != null) {
        for(var i = 0; i < searchHistory.length; i++) {
          var cityButton = $("<button>").attr({
            type: "button", 
            class: "btn btn-light btn-lg btn-block",
            city: searchHistory[i]});
          cityButton.text(searchHistory[i]);
          $(".btn-group-vertical").prepend(cityButton);
        }
      } else {
        searchHistory = [];
      }
    }

    function grabUVData(APIKey, lat, lon) {
      var queryURL = "http://api.openweathermap.org/data/2.5/uvi/forecast?lat=" + lat + "&lon=" + lon + "&appid=" + APIKey;
      var UVSet = $("<p>");
      var UVSpan = $("<span>");
      $.ajax({
        url: queryURL,
        method: "GET"
      }).then(function(response) {
        var UVNum = response[0].value;
        UVSpan.text(UVNum);
        if(UVNum >=0 && UVNum <= 2.9) {
          UVSpan.attr("style", "background-color: green;");
        } else if(UVNum >= 3 && UVNum <= 5.9) {
          UVSpan.attr("style", "background-color: yellow;");
        } else if(UVNum >= 6 && UVNum <= 7.9) {
          UVSpan.attr("style", "background-color: orange;");
        } else if(UVNum >= 8 && UVNum <= 10.9) {
          UVSpan.attr("style", "background-color: red; color: white;");
        } else if(UVNum >= 11) {
          UVSpan.attr("style", "background-color: purple; color: white");
        } 
        UVSet.text("UV Index: ");
        UVSet.append(UVSpan);
      });
      return UVSet;
    }

    function getInfo(citySearchTerm) {
      var APIKey = "ced2cf879bb0aad6596f2794924c76f0";
      var queryURL = "http://api.openweathermap.org/data/2.5/forecast?q=" + citySearchTerm + "&APPID=" + APIKey;

      $.ajax({
        url: queryURL,
        method: "GET"
      }).then(function(response) {
        if(response.cod == "200") {
          if((searchHistory == null) || !(searchHistory.includes(citySearchTerm))) {
            searchHistory.push(citySearchTerm);
          }
          localStorage.setItem("searchHistory", JSON.stringify(searchHistory));
          renderPage();
          var weatherSet = response.list[0];
          var cityText = response.city.name;
          var header = $("<h1>").text(cityText + " (" + grabDate(response, 0) + ")");
          var imageSet = $("<img>").attr("src", "http://openweathermap.org/img/wn/" + weatherSet.weather[0].icon + ".png");
          var temper = weatherSet.main.temp;
          var tempSet = $("<p>").text("Temperature: " + Math.floor((temper - 273.15) * 1.8 + 32) + "\xB0F");
          var humiditySet = $("<p>").text("Humidity: " + weatherSet.main.humidity + "%");
          var windSpeedSet = $("<p>").text("Wind Speed: " + weatherSet.wind.speed + " MPH");
          var latitude = response.city.coord.lat;
          var longitude = response.city.coord.lon;
          var UVSet = grabUVData(APIKey, latitude, longitude);
          header.append(imageSet);
          $(".card-body").append(header, tempSet, humiditySet, windSpeedSet, UVSet);

          for(var i = 0; i < 5; i++) {
            var index = 7 + (i * 8);
            var weatherSet2 = response.list[index];
            var header = $("<h5>").addClass("card-title");
            header.text(grabDate(response, index));
            var imageSet = $("<img>").attr("src", "http://openweathermap.org/img/wn/" + weatherSet2.weather[0].icon + ".png");
            var temper = weatherSet2.main.temp;
            var tempSet = $("<p>").text("Temperature: " + Math.floor((temper - 273.15) * 1.8 + 32) + "\xB0F");
            var humiditySet = $("<p>").text("Humidity: " + weatherSet2.main.humidity + "%");
            $(".card-body" + i).append(header, imageSet, tempSet, humiditySet);
          }
          $(".col-lg-8").attr("style", "display: block");

        }
      });
    }

    $(".btn-primary").on("click", function() {
      var cityNamer = $("#searchTerm").val();
      getInfo(cityNamer);
    });

    $(".btn-block").on("click", function() {
      var cityName = $(this).attr("city");
      alert("clicked!");
      getInfo(cityName);
    });

    renderPage();
    if(searchHistory != null) {
      getInfo(searchHistory[searchHistory.length - 1]);
    }

  </script>
</body>
</html>